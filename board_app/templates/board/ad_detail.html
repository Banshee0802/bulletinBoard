{% extends "base.html" %}
{% load tz %}


{% block title %}{{ advertisement.title }}{% endblock title %}

{% block content %}
<a href='{% url "ad_list" %}' class="btn btn-custom">&larr;Назад</a>

<div class="card text-dark h-100 my-3" style="background-color: #ffdfe7ff">
    <div class="card-body">
        {% if advertisement.image %}
        <img src="{{ advertisement.image.url }}" style="max-width: 100%; max-height: 300px; width: auto; height: auto; object-fit: contain;" class="img-fluid mb-3" alt="{{ advertisement.title }}">
        {% endif %}
        
        <h2 class="card-title mb-3" style="color: #000000ff">{{ advertisement.title }}</h2>
        <p>{{ advertisement.description }}</p>

        <button 
            class='favoriteBtn btn btn-link {% if request.user == advertisement.user %}disabled{% endif %}' 
            data-url='{% url "toggle_favorite" %}'
            data-ad-id='{{ advertisement.id }}'>
          {% if request.user in advertisement.favorites.all %}
            <i class='favoriteIcon bi bi-bookmark-fill'></i>
          {% else %}
            <i class='favoriteIcon bi bi-bookmark'></i>
          {% endif %}
        </button>
        <span class='favoriteCount'>{{ advertisement.favorites.count }}</span>

        {% if advertisement.category %}
        <p>
            <strong>Категория:</strong>
            <a href="{{ advertisement.category.get_absolute_url }}" style='color: #8484f8ff'>
                {{ advertisement.category.name }}
            </a>
        </p>
        {% else %}
        <p><strong>Категория:</strong> не указана</p>
        {% endif %}

        {% if advertisement.tags.all %}
            <p>
                <strong>Теги:</strong>
                    {% for tag in advertisement.tags.all %}
                        <a href="{{ tag.get_absolute_url }}" class="badge bg-secondary me-1 text-decoration-none" style='color: #fdfdfdff'>
                        {{ tag.name }}
                        </a>
                    {% endfor %}
            </p>
        {% else %}
            <p><strong>Теги:</strong> не указаны</p>
        {% endif %}

        <div class="d-flex justify-content-between align-items-center mb-3">
            <small class="text-muted">
                <i class="bi bi-eye"></i> Просмотров: {{ advertisement.views }}
            </small>
        </div>

        <small><strong>Создано: </strong>{{ advertisement.created_at|localtime|date:'Y-m-d H:i:s' }}</small><br>
        <small><strong>Последнее обновление: </strong> {{ advertisement.updated_at|localtime|date:'Y-m-d H:i:s' }}</small>

        <p>Имя пользователя:
            <a href='{% url "profile" user_name=advertisement.user.username %}' style='color: #8484f8ff'>
                {{ advertisement.user }}
            </a>
        </p>

        {% if request.user == advertisement.user %}
        <a href='{% url "ad_edit" advertisement.id %}' class="btn btn-custom">Редактировать</a>
        <a href='{% url "ad_delete" advertisement.slug %}' class="btn btn-delete">
            <i class="bi bi-trash mx-1"></i>Удалить
        </a>
        {% endif %}

        {% if request.user.is_authenticated and request.user != advertisement.user %}
            {% if not has_requested %}
            <form method="POST" action='{% url "send_request" advertisement.id %}'>
                {% csrf_token %}
                <button type="submit" class="btn btn-custom">
                    <i class="bi bi-bell-fill mx-2"></i>Откликнуться
                </button>
            </form>
            {% else %}
            <p><em>Вы уже откликнулись на это объявление</em></p>
            {% endif %}
        {% endif %}
    </div>
</div>

{% with comments_count=advertisement.comments.count %}
<h4 class="mt-4">
  Отзывы (<span id="comments-count">{{ comments_count }}</span>)
</h4>

<div id="comments-container" 
     data-initial-offset="6"
     data-has-more="{% if comments_count > 6 %}true{% else %}false{% endif %}"
     data-url="{% url 'load_more_comments' advertisement.id %}"
     data-trigger-type="button"
     data-load-more-btn="loadMoreCommentsBtn">
    
    {% for comment in comments %}
        {% include "board/includes/comment_container_include.html" %}
    {% empty %}
        <p class="text-muted">Пока нет отзывов. Будьте первым!</p>
    {% endfor %}
</div>

<!-- Кнопка для загрузки отзывов -->
{% if comments_count > 6 %}
<button id="loadMoreCommentsBtn" class="btn btn-custom w-100 my-3">
    <i class="bi bi-arrow-down"></i> Загрузить еще отзывы
</button>
{% endif %}

<!-- Спиннер для отзывов -->
<div id="loadingSpinner" class="text-center d-none my-3">
  <div class="spinner-grow text-primary custom-spinner" role="status">
    <span class="sr-only">Загрузка...</span>
  </div>
</div>
{% endwith %}


        {% if request.user.is_authenticated %}
            <form id="comment-form" method="POST" data-url="{% url 'add_comment' advertisement.id %}" class="mt-3">
        {% csrf_token %}
    <div class="mb-3">
        <textarea name="text" class="form-control" rows="3" placeholder="Оставьте комментарий..." required style="resize: none;"></textarea>
    </div>
    <input type="hidden" name="advertisement_id" value="{{ advertisement.id }}">
        <button type="submit" class="btn btn-custom px-4">
            <i class="bi bi-chat-dots"></i> Отправить
        </button>
            </form>
        {% else %}
            <p class="text-muted mt-3">Чтобы оставить отзыв, <a href="{% url 'login' %}" style="color: #8484f8ff;">войдите в систему</a>.</p>
        {% endif %}
    </div>
</div>
{% endblock content %}